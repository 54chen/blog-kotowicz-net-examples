<!doctype html>
<html>
<head>
<script src="http://code.jquery.com/jquery-1.5.1.min.js"></script>
<script src="md5.js"></script>
<script>
$(function() {
  function markExternal(src) {
    var hash = hex_md5(src);
    log(src + ' is external (' + hash + ')');
    $(document.getElementById('p-' + hash)).addClass('external');
  };

  function markInternal(src) {
    var hash = hex_md5(src);
    log(src + ' is internal (' + hash + ')');
    $(document.getElementById('p-' + hash)).addClass('internal');
  }

  var internalDomain  = new RegExp(document.location.host);

  function checkUrl(realurl, url) {
    if (realurl.match(internalDomain)) {
      markInternal(url);
    } else {
      markExternal(url);
    }
  }

  function log(msg) {
    $('#log')[0].value += msg + "\n";
    if (console && console.log)
      console.log(msg);
  }

  $(document).ajaxError(function(event, xhr, options, error) {
    log('AJAX error ' + error);
  });

  function testPayload(payload) {
    log('Trying "' + payload + "\"");

    $('<img>')
      .load(function() {
        log('Image source is "' + this.src + '"'); 
        this.title = this.src;
        checkUrl(this.src, $(this).data('src'));
      })
      .error(function() {
         log('Image "' + this.src + "\" failed to load.");
         checkUrl(this.src, $(this).data('src'));
       })
      .data('src', payload)
      .attr('src', payload)
      .appendTo('#images');
  }

  $('#url').change(function() {
     testPayload(this.value);
  });

  $("#clear").click(function() {
    $('#log').val('');
    $('#images').empty();
  });

  $('#tests>li>a').live('click', function() {
    $('#url').val($(this).text()).change();
    return false;
  });

  $("#load").click(function() {
    $.getJSON('payload.json', function(json) {
      var li, payload, i, h;
      for (i = 0; i<json.length; i++) {
        payload = json[i].payload;
        li = $('<li>')
           .attr('id', 'p-' + hex_md5(payload))
           .text(i + ": ")
           .append($('<a href=#>').text(payload));
        li.appendTo('#tests');
        testPayload(payload);
       }
    });
  });

});
</script>
<style>
#log {
  display: block;
  width: 40%;
  float: right;
  height: 300px;
}
img {border: 2px solid white;}
a {white-space: pre; font-family: Courier, monospaced; }
.internal, .internal a {color: green;}
.external, .external a {color: red; }
</style>
</head>
<body>
<p>
<button id=load>Load &amp; test payloads</button>
<button id=clear>Clear logs</button>
</p>
Test URL: <textarea id=url></textarea>
<textarea id=log></textarea>
<ul id=tests>
</ul>
<div id=images></div>
</body>
</html>
